name: Build USD

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+'
env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows_x64
          - os: ubuntu-22.04
            platform: linux_x64
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
          repository: PixarAnimationStudios/OpenUSD
          ref: v25.11

    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libx11-dev \
          libxt-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11' 
    - name: Install python packages
      run: |
          python -m pip install --upgrade pip
          pip install PySide6
          pip install PyOpenGL
          pip install jinja2


    - name: Run build scripts (Windows)
      if: runner.os == 'Windows'
      run: |
          python build_scripts/build_usd.py ./Build/Release --build-variant release --toolset v143 --generator "Visual Studio 17 2022" --materialx
          python build_scripts/build_usd.py ./Build/Debug --build-variant debug --toolset v143 --generator "Visual Studio 17 2022" --materialx

    - name: Run build scripts (Linux)
      if: runner.os == 'Linux'
      run: |
          python build_scripts/build_usd.py ./Build/Release --build-variant release --generator Ninja --materialx
          python build_scripts/build_usd.py ./Build/Debug --build-variant debug --generator Ninja --materialx
           
    - name: Archive (Windows)
      if: runner.os == 'Windows'
      id: archive-windows
      shell: pwsh
      run: |
          echo "archiving files..."

          $tagName = & git describe --tags
          $version = $tagName.TrimStart("v")
          $binArchiveDebug = "Lumengine.USD_$version.windows_x64.py3.11_Debug.zip"
          $binArchiveRelease = "Lumengine.USD_$version.windows_x64.py3.11_Release.zip"

          echo "USD_BINARY_ARCHIVE_DEBUG=$binArchiveDebug" >> $env:GITHUB_OUTPUT
          echo "USD_BINARY_ARCHIVE_RELEASE=$binArchiveRelease" >> $env:GITHUB_OUTPUT

          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/bin
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/cmake
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/include
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/lib
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/libraries
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/plugin
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/python
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/resources
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/share
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/CHANGELOG.md
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/LICENSE
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/pxrConfig.cmake
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/README.md
          7z a "$binArchiveDebug" ${{github.workspace}}/Build/Debug/THIRD-PARTY.md

          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/bin
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/cmake
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/include
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/lib
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/libraries
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/plugin
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/python
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/resources
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/share
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/CHANGELOG.md
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/LICENSE
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/pxrConfig.cmake
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/README.md
          7z a "$binArchiveRelease" ${{github.workspace}}/Build/Release/THIRD-PARTY.md

    - name: Archive (Linux)
      if: runner.os == 'Linux'
      id: archive-linux
      shell: bash
      run: |
          echo "archiving files..."

          TAG=$(git describe --tags)
          VERSION=${TAG#v}
          BIN_ARCHIVE_DEBUG="Lumengine.USD_${VERSION}.linux_x64.py3.11_Debug.tar.gz"
          BIN_ARCHIVE_RELEASE="Lumengine.USD_${VERSION}.linux_x64.py3.11_Release.tar.gz"

          echo "USD_BINARY_ARCHIVE_DEBUG=$BIN_ARCHIVE_DEBUG" >> $GITHUB_OUTPUT
          echo "USD_BINARY_ARCHIVE_RELEASE=$BIN_ARCHIVE_RELEASE" >> $GITHUB_OUTPUT

          tar -czvf "$BIN_ARCHIVE_DEBUG" -C Build/Debug .
          tar -czvf "$BIN_ARCHIVE_RELEASE" -C Build/Release .

    - name: Publish (Windows)
      if: runner.os == 'Windows'
      uses: softprops/action-gh-release@v1
      with:
          files: |
            ${{ steps.archive-windows.outputs.USD_BINARY_ARCHIVE_DEBUG }}
            ${{ steps.archive-windows.outputs.USD_BINARY_ARCHIVE_RELEASE }}
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Publish (Linux)
      if: runner.os == 'Linux'
      uses: softprops/action-gh-release@v1
      with:
          files: |
            ${{ steps.archive-linux.outputs.USD_BINARY_ARCHIVE_DEBUG }}
            ${{ steps.archive-linux.outputs.USD_BINARY_ARCHIVE_RELEASE }}
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

